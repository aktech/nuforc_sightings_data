schema: '2.0'
stages:
  save-existing-reports:
    cmd:
    - touch data/raw/nuforc_reports.json
    - cp data/raw/nuforc_reports.json data/raw/nuforc_reports_orig.json
    outs:
    - path: data/raw/nuforc_reports_orig.json
      md5: b31b2c9a959791f64b73eb518dde597f
      size: 345026
  unzip-cities:
    cmd:
    - unzip -o data/external/GeoLite2-City-CSV.zip -d data/external/
    - rm -rf data/external/geolite_city
    - mv -f data/external/GeoLite2-City-CSV_* data/external/geolite_city
    deps:
    - path: data/external/GeoLite2-City-CSV.zip
      md5: b6113dfaf6e0b80cdb30c40434a32427
      size: 47198994
    outs:
    - path: data/external/geolite_city/GeoLite2-City-Blocks-IPv4.csv
      md5: 51fd6e54e1152d66262b74b761037b24
      size: 213775604
    - path: data/external/geolite_city/GeoLite2-City-Locations-en.csv
      md5: 0b8980751ff43c337643b7668446008a
      size: 10254238
  make-cities:
    cmd:
    - python scripts/make_cities.py data/external/geolite_city/GeoLite2-City-Locations-en.csv
      data/external/geolite_city/GeoLite2-City-Blocks-IPv4.csv --output-file data/external/cities.csv
    deps:
    - path: data/external/geolite_city/GeoLite2-City-Blocks-IPv4.csv
      md5: 51fd6e54e1152d66262b74b761037b24
      size: 213775604
    - path: data/external/geolite_city/GeoLite2-City-Locations-en.csv
      md5: 0b8980751ff43c337643b7668446008a
      size: 10254238
    - path: scripts/make_cities.py
      md5: f46af8dbf6a3b8142be74a2584b001fe
      size: 1217
    outs:
    - path: data/external/cities.csv
      md5: be033a4af67469f7f30ccd9798369da1
      size: 6407162
  pull-new-reports:
    cmd:
    - cd nuforc_reports && scrapy crawl nuforc_report_spider --output $(dvc root)/data/raw/nuforc_reports_new.json
      --output-format jsonlines
    outs:
    - path: data/raw/nuforc_reports_new.json
      md5: d41d8cd98f00b204e9800998ecf8427e
      size: 0
  merge-reports:
    cmd:
    - python scripts/union_nuforc_reports.py data/raw/nuforc_reports_orig.json data/raw/nuforc_reports_new.json
      data/raw/nuforc_reports.json
    deps:
    - path: data/raw/nuforc_reports_new.json
      md5: d41d8cd98f00b204e9800998ecf8427e
      size: 0
    - path: data/raw/nuforc_reports_orig.json
      md5: b31b2c9a959791f64b73eb518dde597f
      size: 345026
    - path: scripts/union_nuforc_reports.py
      md5: d14437b7531198ddf7e12cbd61929450
      size: 1130
    outs:
    - path: data/raw/nuforc_reports.json
      md5: b31b2c9a959791f64b73eb518dde597f
      size: 345026
  geocode-reports:
    cmd:
    - python scripts/process_report_data.py data/raw/nuforc_reports.json data/external/cities.csv
      --output-file data/processed/nuforc_reports.csv
    deps:
    - path: data/external/cities.csv
      md5: be033a4af67469f7f30ccd9798369da1
      size: 6407162
    - path: data/raw/nuforc_reports.json
      md5: b31b2c9a959791f64b73eb518dde597f
      size: 345026
    - path: scripts/process_report_data.py
      md5: 7177e5ddc20adbbca89f451acb0fbe9d
      size: 7739
    outs:
    - path: data/processed/nuforc_reports.csv
      md5: 46e27f2f410388f665d20164bf8ee54a
      size: 288232
